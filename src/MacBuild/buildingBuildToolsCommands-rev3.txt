#####
# If on proxied network, set the proxies:

export HTTPS_PROXY=https://proxyout.lanl.gov:8080
export HTTP_PROXY=http://proxyout.lanl.gov:8080
export https_proxy=https://proxyout.lanl.gov:8080
export http_proxy=http://proxyout.lanl.gov:8080

#####
# Create directory structure for build
sudo mkdir -p /opt/tools/downloads
sudo mkdir -p /opt/tools/logs
chown -R <build-user> /opt/tools
cd /opt/tools

#####
# Use Curl to download Qt, SIP and PyQt - it is important to use this
# command as it will follow redirects, where the MacPkgr.py will not.

curl -o downloads/qt-everywhere-opensource-src-5.7.0.tar.gz -L http://download.qt.io/official_releases/qt/5.7/5.7.0/single/qt-everywhere-opensource-src-5.7.0.tar.gz
tar xzvf downloads/qt-everywhere-opensource-src-5.6.1-1.tar.gz

curl -o downloads/sip-4.18.tar.gz -L  http://freefr.dl.sourceforge.net/project/pyqt/sip/sip-4.18/sip-4.18.tar.gz
tar xzvf downloads/sip-4.18.tar.gz

curl -o downloads/PyQt5_gpl-5.6.tar.gz -L  http://sourceforge.net/projects/pyqt/files/PyQt5/PyQt-5.6/PyQt5_gpl-5.6.tar.gz
tar xzvf downloads/PyQt5_gpl-5.6.tar.gz

#####
# Clone the pyinstaller-snapshot repository:

git clone https://github.com/roynielsen17/pyinstaller-snapshot.git 


#####
# Build Qt
cd qt-everywhere-opensource-src-5.7.0

./configure -opensource -confirm-license -release -no-rpath -prefix /opt/tools/lib/Qt5.6.1 -libdir /opt/tools/lib/Qt5.6.1/lib -nomake examples -nomake tests -bindir /opt/tools/lib/Qt5.6.1/bin -headerdir /opt/tools/lib/Qt5.6.1/includes -plugindir /opt/tools/lib/Qt5.6.1/plugins -importdir /opt/tools/lib/Qt5.6.1/qmlOne -qmldir /opt/tools/lib/Qt5.6.1/qmlTwo -datadir /opt/tools/lib/Qt5.6.1/data -docdir /opt/tools/lib/Qt5.6.1/doc -continue -silent -archdatadir /opt/tools/lib/Qt5.6.1/arch -largefile -no-pkg-config -sdk macosx10.11 &> ../logs/qt-configure-out.txt

make -j 4 &> ../logs/qt-make.log

sudo make install &> ../logs/qt-make-install.log

#####
# Build SIP
cd /opt/tools/sip-4.18

python ./configure.py --bindir /opt/tools/bin --destdir /opt/tools/lib/Python/2.7/site-packages --incdir /opt/tools/lib/Python/2.7/site-packages/sip/includes --sipdir /opt/tools/lib/Python/2.7/site-packages/sip/sips --pyidir /opt/tools/lib/Python/2.7/site-packages/sip/pyis --sdk MacOSX10.11.sdk &> ../logs/sip-configure.log

make &> ../logs/sip-make.log
sudo make install &> ../logs/sip-make-install.log


#####
# Build PyQt
cd /opt/tools/PyQt5_gpl-5.6

python ./configure.py --confirm-license --bindir=/opt/tools/bin --destdir=/opt/tools/lib/Python/2.7/site-packages --no-designer-plugin --no-qml-plugin --no-qsci-api --qmake=/opt/tools/lib/Qt5.6.1/bin/qmake --sip=/opt/tools/bin/sip --sip-incdir=/opt/tools/lib/Python/2.7/site-packages/sip/includes -v /opt/tools/lib/Python/2.7/site-packages/PyQt5/sips --verbose &> ../logs/pyqt-configure.log

make -j 4 &> ../logs/pyqt-make.log
sudo make install &> ../logs/pyqt-make-install.log


#####
# The following needs to be setup up before installing pyinstaller, 
# as well as being necessary for build scripts:
export PYTHONPATH=/opt/tools/lib/Python/2.7/site-packages:/opt/tools/lib/Python/2.7/site-packages/PyQt5:/opt/tools/lib/Qt5.6.1/lib:/opt/tools/lib/Python/2.7/site-packages/sip:$PYTHONPATH
export DYLD_LIBRARY_PATH=/opt/tools/lib/Qt5.6.1/lib:/opt/tools/lib/Python/2.7/site-packages:/opt/tools/lib/Python/2.7/site-packages/PyQt5:/opt/tools/lib/Python/2.7/site-packages/sip:$DYLD_LIBRARY_PATH
export DYLD_FRAMEWORK_PATH=/opt/tools/lib/Qt5.6.1/lib:/opt/tools/lib/Python/2.7/site-packages:/opt/tools/lib/Python/2.7/site-packages/PyQt5:/opt/tools/lib/Python/2.7/site-packages/sip:$DYLD_FRAMEWORK_PATH
export LD_FRAMEWORK_PATH=/opt/tools/lib/Qt5.6.1/lib:/opt/tools/lib/Python/2.7/site-packages:/opt/tools/lib/Python/2.7/site-packages/PyQt5:/opt/tools/lib/Python/2.7/site-packages/sip:$LD_FRAMEWORK_PATH
export LD_LIBRARY_PATH=/opt/tools/lib/Qt5.6.1/lib:/opt/tools/lib/Python/2.7/site-packages:/opt/tools/lib/Python/2.7/site-packages/PyQt5:/opt/tools/lib/Python/2.7/site-packages/sip:$LD_LIBRARY_PATH

#####
# Install PyInstaller
cd /opt/tools/pyinstaller-snapshot

git checkout develop

sudo python setup.py install


